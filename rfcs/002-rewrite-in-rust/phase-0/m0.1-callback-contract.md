# M0.1 Callback Contract, Error Taxonomy, and Versioning Policy

Status: completed for Phase 0 planning baseline.

## Scope Constraints

- SQLite-only initial scope.
- SDK owns SQLite lifecycle (open/create/exists/close/export) and runtime integration.
- Rust rewrite engine is invoked through SDK-owned host callbacks.

## Contract Version

- Contract id: `lix.rust-rewrite.callback`
- Contract version: `0.1.0`

## Host Callback Contract

Source of truth types live in `packages/sdk/src/engine/rust-rewrite/callback-contract.ts`.

### execute(request)

Request fields:

- `requestId: string`
- `sql: string`
- `params: readonly unknown[]`
- `statementKind: "read_rewrite" | "write_rewrite" | "validation" | "passthrough"`

Response fields:

- `rows: readonly Record<string, unknown>[]`
- `rowsAffected: number`
- `lastInsertRowId?: number`

### detectChanges(request)

Request fields:

- `requestId: string`
- `pluginKey: string`
- `before: Uint8Array`
- `after: Uint8Array`

Response fields:

- `changes: readonly Record<string, unknown>[]`

## JS-Visible Error Taxonomy

Stable codes for SDK surface:

- `LIX_RUST_SQLITE_EXECUTION`
- `LIX_RUST_DETECT_CHANGES`
- `LIX_RUST_REWRITE_VALIDATION`
- `LIX_RUST_UNSUPPORTED_SQLITE_FEATURE`
- `LIX_RUST_PROTOCOL_MISMATCH`
- `LIX_RUST_TIMEOUT`
- `LIX_RUST_UNKNOWN`

Normalization helper:

- `normalizeRustBoundaryError(input)` maps unknown or host-originated failures into deterministic `code` values.
- Structured errors with a known code preserve their original code.

## Versioning Policy

For callback contract and error taxonomy:

- Add error code: minor version bump.
- Remove error code: major version bump.
- Rename error code: major version bump.
- Message text-only updates: patch version bump.
- Metadata shape expansion (`details` additive fields): minor version bump.

## Verification Evidence

- Type-safe callback examples compile in `packages/sdk/src/engine/rust-rewrite/callback-contract.test.ts`.
- Deterministic error-code mapping tests are in `packages/sdk/src/engine/rust-rewrite/callback-contract.test.ts`.
