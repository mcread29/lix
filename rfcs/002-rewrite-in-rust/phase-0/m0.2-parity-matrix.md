# M0.2 Baseline Parity Matrix and Fixture Mapping

Status: completed for Phase 0 baseline.

## Scope Constraints

- SQLite-only baseline.
- SDK retains SQLite lifecycle ownership.
- Matrix covers current JS preprocessor behavior used as Rust parity target.

## Parity Matrix

| Scenario class | Baseline expectation | Executable fixture mapping | Status |
| --- | --- | --- | --- |
| Read rewrite | Entity/state view reads are rewritten to canonical state tables with equivalent rows returned | `packages/sdk/src/engine/preprocessor/create-preprocessor.test.ts` -> `state_by_version view is rewritten`; `selecting from stored schema view returns rows via preprocessor` | Covered |
| Write rewrite (INSERT) | Inserts into entity views rewrite to `state_by_version` preserving defaults/PK semantics | `packages/sdk/src/engine/preprocessor/entity-views/insert.test.ts` -> `rewrites inserts for stored schema views`; `rewrites inserts for _by_version view`; `rewrites multi-row inserts with JSON payloads` | Covered |
| Write rewrite (UPDATE) | Updates on entity views rewrite to `state_by_version` with JSON-path predicates and version constraints | `packages/sdk/src/engine/preprocessor/entity-views/update.test.ts` -> `rewrites updates for stored schema views`; `entity_id predicate is pushed down when rewriting entity view updates` | Covered |
| Write rewrite (DELETE) | Deletes on entity views rewrite to `state_by_version` while preserving predicate semantics | `packages/sdk/src/engine/preprocessor/entity-views/delete.test.ts` -> `rewrites deletes for stored schema views`; `rewrites delete with OR predicates`; `rewrites delete with subquery predicates referencing other views` | Covered |
| Validation failure (schema/state checks) | Invalid state mutations fail with deterministic validation errors | `packages/sdk/src/state/vtable/validate-state-mutation.test.ts` -> `throws if the schema is not a valid lix schema`; `throws when foreign key reference does not exist`; `throws when primary key violates uniqueness constraint` | Covered |
| Passthrough statements | Unsupported SQL remains passthrough/raw-fragment (no rewrite corruption) | `packages/sdk/src/engine/preprocessor/create-preprocessor.test.ts` -> `unsupported statements are passed through`; `packages/sdk/src/engine/preprocessor/sql-parser/parse.test.ts` -> `returns raw fragment for unsupported statement types` | Covered |

## Verification Samples Executed for M0.2

- `pnpm --filter @lix-js/sdk exec vitest run src/engine/preprocessor/create-preprocessor.test.ts -t "unsupported statements are passed through"`
- `pnpm --filter @lix-js/sdk exec vitest run src/engine/preprocessor/entity-views/insert.test.ts -t "rewrites inserts for stored schema views"`
- `pnpm --filter @lix-js/sdk exec vitest run src/engine/preprocessor/entity-views/update.test.ts -t "rewrites updates for stored schema views"`
- `pnpm --filter @lix-js/sdk exec vitest run src/engine/preprocessor/entity-views/delete.test.ts -t "rewrites deletes for stored schema views"`
- `pnpm --filter @lix-js/sdk exec vitest run src/state/vtable/validate-state-mutation.test.ts -t "throws when foreign key reference does not exist"`

## Gap Ownership

| Gap | Impact | Owner | Due date | Tracking |
| --- | --- | --- | --- | --- |
| `test.skip("preserves SQL expression parameters during insert rewrite")` in `entity-views/insert.test.ts` | SQL-expression insert parity can drift between JS and Rust paths | SDK preprocessor maintainers | 2026-03-12 | Convert skipped test to active parity fixture before `rust_active` defaulting |
| No dedicated fixture asserting parity for ON CONFLICT write rewrites (currently unsupported path) | Unsupported behavior must remain explicitly deterministic across JS/Rust | SDK preprocessor maintainers | 2026-03-19 | Add explicit unsupported/diagnostic fixture documenting expected error contract |
